name: Build, PDF, and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build Docusaurus site
        run: |
          npm run build --if-present

      - name: Install pandoc and TeX (for PDF)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-recommended

      - name: Generate PDF from markdown
        run: |
          mkdir -p build
          # Combine selected markdown files into a single PDF placed into build/
          pandoc -s --pdf-engine=xelatex --toc --metadata=title:"Teaching Physical AI & Humanoid Robotics" --metadata=author:"Spec-Kit Plus" specs/physical-ai-robotics-textbook/*.md docs/*.md -o build/Ai-textbook.pdf || true
        shell: bash

      - name: Show generated PDF size
        run: |
          if [ -f build/Ai-textbook.pdf ]; then ls -lh build/Ai-textbook.pdf; else echo "No PDF generated"; fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
